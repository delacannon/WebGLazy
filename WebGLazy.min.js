/**
 * @file      Exposes the `WebGLazy` API
 * @author    Sean S. LeBlanc
 * @version   1.1.1
 * @license   MIT
 */
var WebGLazy=function(){"use strict";function t(i){if(!t.context&&(t.context=i.getContext("webgl")||i.getContext("experimental-webgl"),!t.context))throw"No WebGL support";return t.context}function i(t){this.options=t||{},this.sources=this.options.sources||["canvas","video","img"],this.source=this.options.source||this.getSource(),this.hideSource=void 0===this.options.hideSource||this.options.hideSource,this.background=this.options.background||"black",this.scaleMultiplier=this.options.scaleMultiplier||1,this.scaleMode=void 0!==this.options.scaleMode?this.options.scaleMode:this.constructor.SCALE_MODES.FIT,this.allowDownscaling=this.options.allowDownscaling||!1,this.timestep=this.options.timestep||1/60*1e3,this.disableFeedbackTexture=!!this.options.disableFeedbackTexture,(void 0===this.options.autoInit||this.options.autoInit)&&this.init()}return t.Shader=function(i,e){this.gl=new t,this.vertSource=i,this.fragSource=e,this.program=this.gl.createProgram();try{this.vertShader=this.compileShader(this.vertSource,this.gl.VERTEX_SHADER),this.fragShader=this.compileShader(this.fragSource,this.gl.FRAGMENT_SHADER)}catch(t){throw this.gl.deleteProgram(this.program),delete this.program,console.error("Couldn't create shader: ",t),t}this.gl.attachShader(this.program,this.vertShader),this.gl.deleteShader(this.vertShader),delete this.vertShader,this.gl.attachShader(this.program,this.fragShader),this.gl.deleteShader(this.fragShader),delete this.fragShader,this.gl.linkProgram(this.program)},t.Shader.prototype.compileShader=function(t,i){try{var e=this.gl.createShader(i);if(this.gl.shaderSource(e,t),this.gl.compileShader(e),!this.gl.getShaderParameter(e,this.gl.COMPILE_STATUS))throw this.gl.getShaderInfoLog(e);return e}catch(e){throw console.error("Couldn't compile shader ("+i+"): ",t,e),e}},t.Shader.prototype.useProgram=function(){this.gl.useProgram(this.program)},t.Texture=function(i,e){this.gl=new t,this.source=i,this.texture=this.gl.createTexture(),this.bind(e),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null)},t.Texture.prototype.update=function(){this.bind(),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.source),this.gl.bindTexture(this.gl.TEXTURE_2D,null)},t.Texture.prototype.bind=function(t){var i=t||this.lastBoundId||0;this.gl.activeTexture(this.gl.TEXTURE0+i),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.lastBoundId=i},i.SCALE_MODES=Object.freeze({FIT:"FIT",COVER:"COVER",MULTIPLES:"MULTIPLES",NONE:"NONE"}),i.prototype.getSource=function(){var t,i=[];for(t=0;t<this.sources.length;++t)i.push(Array.prototype.slice.call(document.getElementsByTagName(this.sources[t])));if(0===(i=Array.prototype.concat.apply([],i)).length)throw"Couldn't find an element from "+this.sources+" to use as a source";return i[0]},i.prototype.insertStylesheet=function(){this.style=document.createElement("style"),document.head.appendChild(this.style),this.style.innerHTML=["html,body,div#canvasContainer{","   padding:0;","   margin:0;","   ","   width:100%;","   height:100%;","","   top:0;","   left:0;","   right:0;","   bottom:0;","","   background: "+this.background+";","   color:#FFFFFF;","","   overflow:hidden;","","   /*cursor:none;*/",this.hideSource?" visibility: hidden!important;":"","}","","canvas#outputCanvas{","   image-rendering: optimizeSpeed;","    image-rendering: -moz-crisp-edges;","   image-rendering: -o-crisp-edges; ","    image-rendering: -webkit-optimize-contrast;","    image-rendering: optimize-contrast;","   image-rendering: crisp-edges;","    image-rendering: pixelated;","    -ms-interpolation-mode: nearest-neighbor;","","   position:absolute;","   margin:auto;","   top:0;","   left:-1000%;","   right:-1000%;","   bottom:0;","",this.hideSource?" visibility: visible!important;":"",this.scaleMode===this.constructor.SCALE_MODES.MULTIPLES?["  transition:","       width  0.2s cubic-bezier(0.22, 1.84, 0.88, 0.77),","       height 0.2s cubic-bezier(0.22, 1.84, 0.88, 0.77);"].join("\n"):"","};"].join("\n")},i.prototype.init=function(){this.size={x:this.source.width||this.source.style.width,y:this.source.height||this.source.style.height},this.size.x*=this.scaleMultiplier||1,this.size.y*=this.scaleMultiplier||1,this.ratio=this.size.x/this.size.y,this.insertStylesheet(),this.canvasContainer=document.createElement("div"),this.canvasContainer.id="canvasContainer",this.allowDownscaling||(this.canvasContainer.style.minWidth=this.size.x+"px",this.canvasContainer.style.minHeight=this.size.y+"px"),this.canvas=document.createElement("canvas"),this.canvas.id="outputCanvas",this.canvas.width=this.size.x,this.canvas.height=this.size.y,this.canvas.style.width=this.canvas.style.height=0,this.scaleMultiplier=1,this.canvasContainer.appendChild(this.canvas),document.body.appendChild(this.canvasContainer);try{this.gl=new t(this.canvas),this.render=this.renderGL}catch(t){console.warn("Falling back to canvas rendering: ",t),this.render=this.renderCanvas,this.canvas2d=this.canvas.getContext("2d")}if(this.gl){var i,e,s=document.getElementById("shader-vert"),r=document.getElementById("shader-frag");s&&(i=s.innerHTML),r&&(e=r.innerHTML),i=i||["// default vertex shader","attribute vec4 position;","void main() {","   gl_Position = position;","}"].join("\n"),e=e||["// default fragment shader","precision mediump float;","uniform sampler2D tex0;","uniform sampler2D tex1;","uniform vec2 resolution;","","void main() {","   vec2 coord = gl_FragCoord.xy;","   vec2 uv = coord.xy / resolution.xy;","   gl_FragColor = vec4(texture2D(tex1, uv).rgb, 1.0);","}"].join("\n"),this.shader=new t.Shader(i,e),this.vertices=new Float32Array([-1,-1,1,-1,-1,1,1,-1,1,1,-1,1]),this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vertices,this.gl.STATIC_DRAW),this.textureSource=new t.Texture(this.source,0),this.disableFeedbackTexture||(this.textureFeedback=new t.Texture(this.canvas,1)),this.glLocations={position:this.gl.getAttribLocation(this.shader.program,"position"),tex0:this.gl.getUniformLocation(this.shader.program,"tex0"),tex1:this.gl.getUniformLocation(this.shader.program,"tex1"),time:this.gl.getUniformLocation(this.shader.program,"time"),resolution:this.gl.getUniformLocation(this.shader.program,"resolution")},this.gl.enableVertexAttribArray(this.glLocations.position),this.gl.viewport(0,0,this.size.x,this.size.y),this.shader.useProgram(),this.gl.vertexAttribPointer(this.glLocations.position,2,this.gl.FLOAT,!1,0,0),this.gl.clearColor(0,0,0,1),this.gl.uniform1i(this.glLocations.tex0,0),this.gl.uniform1i(this.glLocations.tex1,1),this.gl.uniform2f(this.glLocations.resolution,this.size.x,this.size.y)}window.onresize=this.onResize.bind(this),window.onresize(),this.accumulator=0,this.startTime=performance.now(),this.curTime=this.lastTime=0,this.main=this.main.bind(this),this.main(this.curTime)},i.prototype.main=function(t){this.lastTime=this.curTime,this.curTime=(t||performance.now())-this.startTime,this.deltaTime=this.curTime-this.lastTime,this.accumulator+=this.deltaTime,this.accumulator>this.timestep&&(this.render(),this.accumulator-=this.timestep),requestAnimationFrame(this.main)},i.prototype.renderCanvas=function(){this.canvas2d.clearRect(0,0,this.size.x,this.size.y),this.canvas2d.drawImage(this.source,0,0)},i.prototype.renderGL=function(){this.textureSource.update(),this.gl.uniform1f(this.glLocations.time,this.curTime),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.shader.useProgram(),this.textureSource.bind(),this.disableFeedbackTexture||this.textureFeedback.bind(),this.gl.drawArrays(this.gl.TRIANGLES,0,this.vertices.length/2),this.disableFeedbackTexture||this.textureFeedback.update()},i.prototype.onResize=function(){var t,i,e=this.canvasContainer.offsetWidth,s=this.canvasContainer.offsetHeight,r=e/s;switch(r<this.ratio?s=Math.round(e/this.ratio):e=Math.round(s*this.ratio),this.scaleMode){case this.constructor.SCALE_MODES.MULTIPLES:for(this.scaleMultiplier=1,t=this.size.x,i=this.size.y;t+this.size.x<=e||i+this.size.y<=s;)t+=this.size.x,i+=this.size.y,this.scaleMultiplier+=1;break;case this.constructor.SCALE_MODES.FIT:t=e,i=s,this.scaleMultiplier=e/this.size.x;break;case this.constructor.SCALE_MODES.COVER:e=this.canvasContainer.offsetWidth,s=this.canvasContainer.offsetHeight,r<this.ratio?e=Math.round(s*this.ratio):s=Math.round(e/this.ratio),t=e,i=s,this.scaleMultiplier=e/this.size.x;break;case this.constructor.SCALE_MODES.NONE:this.scaleMultiplier=1,t=this.size.x,i=this.size.y}this.canvas.style.width=t+"px",this.canvas.style.height=i+"px"},i}();